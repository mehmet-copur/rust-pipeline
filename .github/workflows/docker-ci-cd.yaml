name: Docker CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - '.dockerignore'
      - '**/*.sh'
  pull_request:
    branches:
      - main

jobs:
  docker-build:
    runs-on: ubuntu-latest
    steps:
      - name: Build Docker Image
        uses: org-name/github-actions-library/actions/docker/build-and-push@v1
        with:
          dockerfile: './Dockerfile'
          context: '.'
          image-name: 'myapp/${{ github.repository }}'
          image-tag: '${{ github.sha }}'
          registry-url: 'docker.io'
          registry-username: ${{ secrets.DOCKER_HUB_USERNAME }}
          registry-password: ${{ secrets.DOCKER_HUB_PASSWORD }}
          push: 'false' # Set to 'true' if you want to push to registry on every build

  security-scan:
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
      - name: Docker Image Security Scan
        uses: org-name/github-actions-library/actions/security/dependency-scan@v1
        with:
          image-name: 'myapp/${{ github.repository }}:${{ github.sha }}'

  deploy:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - name: Deploy Docker Image to Kubernetes
        uses: org-name/github-actions-library/actions/kubernetes/deploy@v1
        with:
          kubeconfig-data: ${{ secrets.KUBECONFIG_DATA }}
          chart-path: './charts/myapp'
          release-name: 'myapp'
          namespace: 'production'
          values-file: 'values-prod.yaml'
          extra-args: '--set image.tag=${{ github.sha }}'

